<!DOCTYPE html>
<html lang="pt-br">

<head>

  <link rel="shortcut icon" href="../assets/icon/favicon2.ico" type="image/x-icon">
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>HafuTech | Dashboard</title>
  <link rel="stylesheet" href="../../css/dashboards.css">
  <!-- <link rel="stylesheet" href="../../css/estilo.css"> -->
  <script src="../../js/sessao.js"></script>

  <link rel="preconnect" href="https://fonts.gstatic.com">
  <link
    href="https://fonts.googleapis.com/css2?family=Alfa+Slab+One&family=Poppins:ital,wght@0,100;0,200;0,300;0,400;0,500;0,600;0,700;0,800;0,900;1,100;1,200;1,300;1,400;1,500;1,600;1,700;1,800;1,900&display=swap"
    rel="stylesheet">

  <!-- Biblioteca do Font Awesome -->
  <script src="https://kit.fontawesome.com/9f7414eb10.js" crossorigin="anonymous"></script>

  <!-- Biblioteca do ChartApex -->
  <script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>

</head>

<body>

  <div class="header-left">

    <a href="../../index-logado.html"><img src="../../assets/logo.png" alt="LOGO"></a>

    <div class="hello">
      <h3>Olá, <span id="b_usuario">usuário</span>!</h3>
    </div>

    <div class="btn-nav-white">
      <a href="edicao-funcionario.html">
        <h3>Perfil</h3>
      </a>
    </div>


    <div class="btn-nav">
      <a href="dashboard-funcionario.html">
        <h3>Dashboard</h3>
      </a>
    </div>

    <div class="btn-nav-white">
      <a href="mural-funcionario.html">
        <h3>Análises</h3>
      </a>
    </div>

    <div class="btn-logout" onclick="limparSessao()">
      <h3>Sair</h3>
    </div>

  </div>

  <main class="dash">
    <section class="parte-cima-dash">
      <div class="nome-pagina-dash">Taxa de Evasão Escolar - INSE e Regiões Brasileiras</div>
    </section>

    <div class="main-dash">

      <div class="container-kpi">
        <section class="lado-esquerdo">
          <section class="kpis">
            <div class="kpis-destaque">
              <article class="kpi-destaque orange">
                <h3>Total de escolas críticas</h3>
                <p class="valor-kpi" id="kpi_total_escolas_criticas">-</p>
              </article>

              <article class="kpi-destaque">
                <h3>Alunos em escolas críticas</h3>
                <p class="valor-kpi" id="kpi_total_alunos_criticos">-</p>
              </article>
            </div>

            <div class="escola-critica">
              <h3>Escolas críticas por região</h3>

              <div id="lista_escolas_criticas" class="tabela-escolas-criticas">
              </div>
            </div>

            <div class="grafico-card1">
              <div id="chart1"></div>
            </div>

          </section>
        </section>
        <section class="lado-direito">
          <section class="graficos">
            <div class="grafico-card2">
              <div id="chart3"></div>
            </div>
            <div class="teste">
              <div class="grafico-pizza">
                <div class="grafico-card3">
                  <div id="chart2"></div>
                </div>
              </div>
              <div class="explicacao-pizza">
                <h3>Legenda Níveis INSE</h3>
                <div class="legenda">
                  <div class="valor-inse">
                    <h3>Valor INSE</h3>
                    menor que 30<br>
                    30 a 40<br>
                    40 a 45<br>
                    45 a 50<br>
                    50 a 55<br>
                    55 a 60<br>
                    60 a 70<br>
                    maior que 70<br>
                  </div>
                  <div class="nivel-inse">
                    <h3>Nível INSE</h3>
                    1<br>
                    2<br>
                    3<br>
                    4<br>
                    5<br>
                    6<br>
                    7<br>
                    8<br>
                  </div>
                </div>

              </div>
            </div>
          </section>
        </section>

      </div>

      <script>
        // mostra o nome do usuário logado
        b_usuario.innerHTML = sessionStorage.NOME_USUARIO;

        document.addEventListener("DOMContentLoaded", function () {
          carregarKpis();
          carregarGraficoPizza();
          carregarGraficoPiramide();
          carregarGraficoBarra();
          carregarListaEscolasCriticas();
        });

        // ===================== KPIs =====================

        function carregarKpis() {
          // KPI 1 – total de escolas críticas
          fetch("/dashboard/total-escolas-criticas")
            .then(function (resposta) {
              return resposta.status === 200 ? resposta.json() : null;
            })
            .then(function (dado) {
              if (!dado) return;
              var elementoKpiEscolas = document.getElementById("kpi_total_escolas_criticas");
              if (elementoKpiEscolas) {
                elementoKpiEscolas.innerText = dado.total_escolas_criticas;
              }
            })
            .catch(function (erro) {
              console.error("Erro KPI total escolas críticas:", erro);
            });

          // KPI 2 – total de alunos em escolas críticas
          fetch("/dashboard/total-alunos-criticos")
            .then(function (resposta) {
              return resposta.status === 200 ? resposta.json() : null;
            })
            .then(function (dado) {
              if (!dado) return;
              var elementoKpiAlunos = document.getElementById("kpi_total_alunos_criticos");
              if (elementoKpiAlunos) {
                elementoKpiAlunos.innerText = dado.total_alunos_criticos;
              }
            })
            .catch(function (erro) {
              console.error("Erro KPI total alunos críticos:", erro);
            });
        }

        // ===================== GRÁFICO DE PIZZA =====================

        function carregarGraficoPizza() {
          fetch("/dashboard/alunos-nivel-inse")
            .then(function (resposta) {
              if (resposta.status === 204) {
                console.warn("Nenhum dado para alunos por nível INSE");
                return null;
              }
              return resposta.json();
            })
            .then(function (dados) {
              if (!dados) return;

              var seriesAlunos = dados.map(function (registro) {
                return Number(registro.total_alunos);
              });

              var labelsInse = dados.map(function (registro) {
                return "Grupo " + registro.nivel_inse;
              });

              var opcoesPizza = {
                series: seriesAlunos,
                chart: {
                  type: "pie",
                  height: 280
                },
                title: {
                  text: "Alunos por Nível INSE",
                  align: "middle"
                },
                labels: labelsInse,
                colors: [
                  "#E5A72A",
                  "#F2C94C",
                  "#F2994A",
                  "#EB5757",
                  "#6FCF97",
                  "#56CCF2",
                  "#9B51E0",
                  "#2D9CDB"
                ],
                legend: {
                  position: "bottom",
                  fontSize: "16px"
                },
                dataLabels: {
                  enabled: true,
                  formatter: function (valor) {
                    return valor.toFixed(1) + "%";
                  }
                }
              };

              var graficoPizza = new ApexCharts(
                document.querySelector("#chart2"),
                opcoesPizza
              );
              graficoPizza.render();
            })
            .catch(function (erro) {
              console.error("Erro ao carregar gráfico de pizza:", erro);
            });
        }

        // ===================== GRÁFICO PIRÂMIDE =====================

        function carregarGraficoPiramide() {
          fetch("/dashboard/pontos-inse-regiao")
            .then(function (resposta) {
              if (resposta.status === 204) {
                console.warn("Nenhum dado para pontos INSE por região");
                return null;
              }
              return resposta.json();
            })
            .then(function (dados) {
              if (!dados) return;

              var categoriasRegiao = dados.map(function (registro) {
                return registro.regiao;
              });

              var valoresInse = dados.map(function (registro) {
                return Number(registro.valor_inse);
              });

              var opcoesPiramide = {
                series: [
                  {
                    name: "Soma INSE",
                    data: valoresInse
                  }
                ],
                chart: {
                  type: "bar",
                  height: 350,
                  dropShadow: {
                    enabled: true
                  }
                },
                plotOptions: {
                  bar: {
                    borderRadius: 0,
                    horizontal: true,
                    distributed: true,
                    barHeight: "100%",
                    isFunnel: true
                  }
                },
                dataLabels: {
                  enabled: true,
                  formatter: function (valor, contexto) {
                    return categoriasRegiao[contexto.dataPointIndex];
                  },
                  dropShadow: {
                    enabled: true
                  }
                },
                title: {
                  text: "Pontos INSE por Região",
                  align: "middle"
                },
                xaxis: {
                  categories: categoriasRegiao
                },
                legend: {
                  show: false
                }
              };

              var graficoPiramide = new ApexCharts(
                document.querySelector("#chart3"),
                opcoesPiramide
              );
              graficoPiramide.render();
            })
            .catch(function (erro) {
              console.error("Erro ao carregar gráfico pirâmide:", erro);
            });
        }

        // ===================== GRÁFICO BARRAS (REDE) =====================

        function carregarGraficoBarra() {
          fetch("/dashboard/media-inse-rede")
            .then(function (resposta) {
              if (resposta.status === 204) {
                console.warn("Nenhum dado para média INSE por rede");
                return null;
              }
              return resposta.json();
            })
            .then(function (dados) {
              if (!dados) return;

              var categoriasRede = dados.map(function (registro) {
                return registro.rede;
              });

              var valoresMediaInse = dados.map(function (registro) {
                return Number(registro.media_inse);
              });

              var opcoesBarra = {
                series: [
                  {
                    data: valoresMediaInse
                  }
                ],
                chart: {
                  type: "bar",
                  height: 260
                },
                plotOptions: {
                  bar: {
                    borderRadius: 4,
                    borderRadiusApplication: "end",
                    horizontal: true
                  }
                },
                dataLabels: {
                  enabled: false
                },
                xaxis: {
                  categories: categoriasRede
                },
                title: {
                  text: "Média INSE por Rede",
                  align: "left"
                }
              };

              var graficoBarra = new ApexCharts(
                document.querySelector("#chart1"),
                opcoesBarra
              );
              graficoBarra.render();
            })
            .catch(function (erro) {
              console.error("Erro ao carregar gráfico de barras:", erro);
            });
        }

        // ===================== TABELA ESCOLAS CRÍTICAS =====================

        function carregarListaEscolasCriticas() {
          var containerTabela = document.getElementById("lista_escolas_criticas");
          if (!containerTabela) return;

          fetch("/dashboard/escolas-criticas-regiao")
            .then(function (resposta) {
              if (resposta.status === 204) {
                containerTabela.innerHTML = "<p>Nenhum dado encontrado.</p>";
                return null;
              }
              return resposta.json();
            })
            .then(function (dados) {
              if (!dados) return;

              var linhasTabela = dados
                .map(function (registro) {
                  return `
              <tr>
                <td>${registro.regiao}</td>
                <td>${registro.inse_2014}</td>
                <td>${registro.inse_2015}</td>
                <td>${registro.qtd_escolas_criticas}</td>
              </tr>
            `;
                })
                .join("");

              containerTabela.innerHTML = `
          <table>
            <thead>
              <tr>
                <th>Região</th>
                <th>INSE 2014</th>
                <th>INSE 2015</th>
                <th>Escolas críticas</th>
              </tr>
            </thead>
            <tbody>
              ${linhasTabela}
            </tbody>
          </table>
        `;
            })
            .catch(function (erro) {
              console.error("Erro ao carregar escolas críticas por região:", erro);
              containerTabela.innerHTML = "<p>Erro ao carregar dados.</p>";
            });
        }
      </script>

</body>

</html>